<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Navigation System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; background: #000; }
        #imageContainer { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: #1a1a1a; }
        #currentImage { max-width: 100%; max-height: 100%; object-fit: contain; }
        #preloadContainer { display: none; }
        #locationInfo { position: absolute; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.8); color: white; padding: 15px 25px; border-radius: 10px; font-size: 18px; font-weight: bold; z-index: 100; backdrop-filter: blur(10px); }
        #controls { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 100; }
        .nav-grid { display: grid; grid-template-columns: 100px 100px 100px; grid-template-rows: 100px 100px 100px; gap: 10px; }
        .nav-btn { background: rgba(67, 133, 245, 0.9); border: 3px solid white; border-radius: 15px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .nav-btn:hover:not(:disabled) { background: rgba(67, 133, 245, 1); transform: scale(1.05); box-shadow: 0 0 20px rgba(67, 133, 245, 0.6); }
        .nav-btn:disabled { background: rgba(100, 100, 100, 0.5); border-color: rgba(150, 150, 150, 0.5); cursor: not-allowed; opacity: 0.3; }
        #forwardBtn { grid-column: 2; grid-row: 1; }
        #leftBtn { grid-column: 1; grid-row: 2; }
        #backwardBtn { grid-column: 2; grid-row: 3; }
        #rightBtn { grid-column: 3; grid-row: 2; }
        .arrow { font-size: 28px; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px; z-index: 50; }
        #adminToggle { position: absolute; top: 20px; right: 20px; background: rgba(67, 133, 245, 0.9); border: none; color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; z-index: 150; transition: all 0.3s ease; }
        #adminPanel { position: fixed; top: 0; right: -500px; width: 500px; height: 100vh; background: rgba(20, 20, 20, 0.98); color: white; padding: 25px; z-index: 200; backdrop-filter: blur(20px); transition: right 0.4s ease; overflow-y: auto; border-left: 2px solid rgba(67, 133, 245, 0.5); }
        #adminPanel.open { right: 0; }
        #adminPanel h2 { margin-bottom: 20px; font-size: 24px; color: #4285f5; }
        #adminPanel h3 { margin-top: 25px; margin-bottom: 15px; font-size: 18px; color: #66a3ff; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 8px; }
        .admin-section { margin-bottom: 25px; }
        .admin-section label { display: block; margin-bottom: 8px; font-size: 14px; color: #ccc; }
        .admin-section input { width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px; color: white; font-size: 14px; margin-bottom: 10px; }
        .admin-btn { background: rgba(67, 133, 245, 0.9); border: none; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; transition: all 0.3s ease; }
        .admin-btn:hover { background: rgba(67, 133, 245, 1); }
        .admin-btn.danger { background: rgba(220, 53, 69, 0.9); }
        .admin-btn.success { background: rgba(40, 167, 69, 0.9); }
        .direction-config { background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .direction-config h4 { margin-bottom: 10px; color: #4285f5; font-size: 16px; }
        .current-link { background: rgba(40, 167, 69, 0.2); padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 13px; }
        .no-link-indicator { background: rgba(220, 53, 69, 0.2); padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 13px; color: #ff6b6b; }
        .status-message { padding: 12px; border-radius: 6px; margin-top: 15px; font-size: 13px; display: none; }
        .status-message.success { background: rgba(40, 167, 69, 0.3); color: #90ee90; }
        .status-message.error { background: rgba(220, 53, 69, 0.3); color: #ff6b6b; }
        .node-list { max-height: 150px; overflow-y: auto; background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 5px; margin-top: 10px; }
        .node-item { padding: 8px; margin: 5px 0; background: rgba(67, 133, 245, 0.2); border-radius: 4px; cursor: pointer; transition: all 0.2s ease; }
        .node-item:hover { background: rgba(67, 133, 245, 0.4); transform: translateX(5px); }
        #passwordModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 250; justify-content: center; align-items: center; }
        #passwordModal.active { display: flex; }
        .password-container { background: rgba(20, 20, 20, 0.98); padding: 40px; border-radius: 15px; text-align: center; border: 2px solid rgba(67, 133, 245, 0.5); }
        .password-container h3 { color: #4285f5; margin-bottom: 20px; font-size: 24px; }
        .password-container input { width: 300px; padding: 15px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; color: white; font-size: 16px; margin-bottom: 20px; text-align: center; }
        .password-container input:focus { outline: none; border-color: #4285f5; }
        .password-container button { padding: 12px 30px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 0 10px; }
        .password-container .submit-btn { background: rgba(67, 133, 245, 0.9); color: white; }
        .password-container .submit-btn:hover { background: rgba(67, 133, 245, 1); }
        .password-container .cancel-btn { background: rgba(220, 53, 69, 0.9); color: white; }
        .password-container .cancel-btn:hover { background: rgba(220, 53, 69, 1); }
        .password-error { color: #ff6b6b; margin-top: 10px; font-size: 14px; display: none; }
        #cameraModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 300; justify-content: center; align-items: center; }
        #cameraModal.active { display: flex; }
        .camera-container { background: rgba(20, 20, 20, 0.98); padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90%; overflow: auto; }
        .camera-container h3 { color: #4285f5; margin-bottom: 20px; text-align: center; }
        #cameraVideo { width: 100%; max-width: 640px; border-radius: 10px; margin-bottom: 15px; display: block; }
        #capturedCanvas { display: none; }
        #capturedPreview { width: 100%; max-width: 640px; border-radius: 10px; margin-bottom: 15px; display: none; }
        .camera-controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .camera-controls button { padding: 12px 24px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
        #captureBtn { background: rgba(67, 133, 245, 0.9); color: white; }
        #retakeBtn { background: rgba(255, 193, 7, 0.9); color: #000; display: none; }
        #useCaptureBtn { background: rgba(40, 167, 69, 0.9); color: white; display: none; }
        #closeCameraBtn { background: rgba(220, 53, 69, 0.9); color: white; }
        .upload-camera-choice { display: flex; gap: 10px; margin-top: 10px; }
        .upload-camera-choice button { flex: 1; padding: 12px; font-size: 14px; }
        #exportModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 350; justify-content: center; align-items: center; }
        #exportModal.active { display: flex; }
        .export-container { background: rgba(20, 20, 20, 0.98); padding: 40px; border-radius: 15px; width: 90%; max-width: 500px; }
        .export-container h3 { color: #4285f5; margin-bottom: 20px; text-align: center; }
        .export-option { background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s ease; }
        .export-option:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }
        .export-option h4 { color: #66a3ff; margin-bottom: 8px; }
        .export-option p { color: #ccc; font-size: 14px; margin-bottom: 0; }
    </style>
</head>
<body>
    <button id="adminToggle">‚öôÔ∏è Admin Panel</button>
    <div id="imageContainer">
        <div id="loading">Loading...</div>
        <img id="currentImage" src="" alt="Campus View" style="display: none;">
        <div id="preloadContainer"></div>
        <div id="locationInfo">Location: <span id="locationId">-</span></div>
        <div id="controls">
            <div class="nav-grid">
                <button id="forwardBtn" class="nav-btn"><span class="arrow">‚Üë</span></button>
                <button id="leftBtn" class="nav-btn"><span class="arrow">‚Üê</span></button>
                <button id="backwardBtn" class="nav-btn"><span class="arrow">‚Üì</span></button>
                <button id="rightBtn" class="nav-btn"><span class="arrow">‚Üí</span></button>
            </div>
        </div>
    </div>
    <div id="adminPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">üõ†Ô∏è Admin Panel</h2>
            <button onclick="document.getElementById('adminPanel').classList.remove('open')" style="background: rgba(220, 53, 69, 0.9); border: none; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold;">‚úï Close</button>
        </div>
        <div class="admin-section"><h3>Current: <span id="adminCurrentLocation">-</span></h3></div>
        <div class="admin-section">
            <h3>üìÅ Upload Images</h3>
            <p style="font-size: 13px; color: #ccc; margin-bottom: 15px;">Upload or capture images</p>
            <input type="file" id="fileUpload" accept="image/*" style="display:none;" onchange="handleFileUpload(event)">
            <div style="margin-bottom: 15px;">
                <p style="font-size: 14px; color: #66a3ff; margin-bottom: 8px;">‚¨ÜÔ∏è Forward</p>
                <div class="upload-camera-choice">
                    <button class="admin-btn" onclick="uploadForDirection('forward')">üìÅ Upload</button>
                    <button class="admin-btn success" onclick="openCameraForDirection('forward')">üì∑ Camera</button>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <p style="font-size: 14px; color: #66a3ff; margin-bottom: 8px;">‚¨áÔ∏è Backward</p>
                <div class="upload-camera-choice">
                    <button class="admin-btn" onclick="uploadForDirection('backward')">üìÅ Upload</button>
                    <button class="admin-btn success" onclick="openCameraForDirection('backward')">üì∑ Camera</button>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <p style="font-size: 14px; color: #66a3ff; margin-bottom: 8px;">‚¨ÖÔ∏è Left</p>
                <div class="upload-camera-choice">
                    <button class="admin-btn" onclick="uploadForDirection('left')">üìÅ Upload</button>
                    <button class="admin-btn success" onclick="openCameraForDirection('left')">üì∑ Camera</button>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <p style="font-size: 14px; color: #66a3ff; margin-bottom: 8px;">‚û°Ô∏è Right</p>
                <div class="upload-camera-choice">
                    <button class="admin-btn" onclick="uploadForDirection('right')">üìÅ Upload</button>
                    <button class="admin-btn success" onclick="openCameraForDirection('right')">üì∑ Camera</button>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <p style="font-size: 14px; color: #66a3ff; margin-bottom: 8px;">‚ûï New Node</p>
                <div class="upload-camera-choice">
                    <button class="admin-btn" onclick="uploadForNewNode()">üìÅ Upload</button>
                    <button class="admin-btn success" onclick="openCameraForNewNode()">üì∑ Camera</button>
                </div>
            </div>
        </div>
        <div class="admin-section">
            <h3>üìç Links</h3>
            <div class="direction-config">
                <h4>‚¨ÜÔ∏è Forward</h4><div id="forwardStatus"></div>
                <input type="text" id="forwardInput" placeholder="Node ID">
                <button class="admin-btn" onclick="setDirection('forward')">Set</button>
                <button class="admin-btn danger" onclick="removeDirection('forward')">Remove</button>
            </div>
            <div class="direction-config">
                <h4>‚¨áÔ∏è Backward</h4><div id="backwardStatus"></div>
                <input type="text" id="backwardInput" placeholder="Node ID">
                <button class="admin-btn" onclick="setDirection('backward')">Set</button>
                <button class="admin-btn danger" onclick="removeDirection('backward')">Remove</button>
            </div>
            <div class="direction-config">
                <h4>‚¨ÖÔ∏è Left</h4><div id="leftStatus"></div>
                <input type="text" id="leftInput" placeholder="Node ID">
                <button class="admin-btn" onclick="setDirection('left')">Set</button>
                <button class="admin-btn danger" onclick="removeDirection('left')">Remove</button>
            </div>
            <div class="direction-config">
                <h4>‚û°Ô∏è Right</h4><div id="rightStatus"></div>
                <input type="text" id="rightInput" placeholder="Node ID">
                <button class="admin-btn" onclick="setDirection('right')">Set</button>
                <button class="admin-btn danger" onclick="removeDirection('right')">Remove</button>
            </div>
        </div>
        <div class="admin-section">
            <h3>‚ûï Add Node</h3>
            <input type="text" id="newNodeId" placeholder="Node ID">
            <input type="text" id="newNodeImage" placeholder="Auto-filled" readonly>
            <button class="admin-btn success" onclick="addNewNode()">Create</button>
        </div>
        <div class="admin-section">
            <h3>üíæ Export Data</h3>
            <button class="admin-btn" onclick="openExportModal()">üì§ Export All Data</button>
            <button class="admin-btn success" onclick="exportData()">üíæ Backup Now</button>
        </div>
        <div class="admin-section"><h3>üìã All Nodes</h3><div class="node-list" id="nodeList"></div></div>
        <div id="statusMessage" class="status-message"></div>
    </div>
    <div id="cameraModal">
        <div class="camera-container">
            <h3 id="cameraTitle">üì∑ Capture Image</h3>
            <video id="cameraVideo" autoplay playsinline></video>
            <img id="capturedPreview" alt="Captured">
            <canvas id="capturedCanvas"></canvas>
            <div class="camera-controls">
                <button id="captureBtn" onclick="captureImage()">üì∏ Capture</button>
                <button id="retakeBtn" onclick="retakeImage()">üîÑ Retake</button>
                <button id="useCaptureBtn" onclick="useCapturedImage()">‚úÖ Use</button>
                <button id="closeCameraBtn" onclick="closeCamera()">‚ùå Cancel</button>
            </div>
        </div>
    </div>
    <div id="passwordModal">
        <div class="password-container">
            <h3>üîí Admin Access</h3>
            <p style="color: #ccc; margin-bottom: 20px;">Enter password to access admin panel</p>
            <input type="password" id="passwordInput" placeholder="Enter password" onkeypress="if(event.key==='Enter')checkPassword()">
            <div class="password-error" id="passwordError">‚ùå Incorrect password</div>
            <div style="margin-top: 20px;">
                <button class="submit-btn" onclick="checkPassword()">üîì Unlock</button>
                <button class="cancel-btn" onclick="closePasswordModal()">‚ùå Cancel</button>
            </div>
        </div>
    </div>
    <div id="exportModal">
        <div class="export-container">
            <h3>üì§ Export Data</h3>
            <div class="export-option" onclick="exportAllData()">
                <h4>üìä JSON Data + Images</h4>
                <p>Export complete navigation data with all images</p>
            </div>
            <div class="export-option" onclick="exportImagesOnly()">
                <h4>üñºÔ∏è All Images Only</h4>
                <p>Download all images as separate files</p>
            </div>
            <div class="export-option" onclick="exportStructureOnly()">
                <h4>üó∫Ô∏è Structure Only</h4>
                <p>Export just the node connections (no images)</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="admin-btn danger" onclick="closeExportModal()">‚ùå Close</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script>
let g={},loc="1",nCnt=1000,preloadedImages={},cam=null,capData=null,capMode=null,capDir=null;
let uploadMode=null,uploadDir=null;
const el={img:document.getElementById('currentImage'),locId:document.getElementById('locationId'),load:document.getElementById('loading'),fwd:document.getElementById('forwardBtn'),bwd:document.getElementById('backwardBtn'),left:document.getElementById('leftBtn'),right:document.getElementById('rightBtn'),adminP:document.getElementById('adminPanel'),adminT:document.getElementById('adminToggle'),preload:document.getElementById('preloadContainer'),camM:document.getElementById('cameraModal'),camV:document.getElementById('cameraVideo'),capC:document.getElementById('capturedCanvas'),capP:document.getElementById('capturedPreview')};

// Initial graph data - using local images from images folder
for(let i=1;i<=10;i++)g[String(i)]={image:`images/${i}.jpeg`,forward:i<10?String(i+1):null,backward:i>1?String(i-1):null,left:null,right:null};

function preloadImage(src){if(!src||preloadedImages[src])return;const img=new Image();img.src=src;preloadedImages[src]=img;el.preload.appendChild(img);}
function preloadAdjacentImages(){const n=g[loc];if(!n)return;if(n.forward&&g[n.forward])preloadImage(g[n.forward].image);if(n.backward&&g[n.backward])preloadImage(g[n.backward].image);if(n.left&&g[n.left])preloadImage(g[n.left].image);if(n.right&&g[n.right])preloadImage(g[n.right].image);}
async function init(){
    localforage.getItem('campusNav').then(d=>{if(d){g=d;console.log('Loaded');}updateView();updateAdminPanel();updateNodeList();preloadAdjacentImages();});
    localforage.getItem('nodeCounter').then(c=>{if(c)nCnt=c;});
    attachListeners();
}
function updateView(){const n=g[loc];if(!n)return;if(preloadedImages[n.image]){el.img.src=n.image;el.load.style.display='none';el.img.style.display='block';}else{el.load.style.display='block';el.img.style.display='none';el.img.onload=()=>{el.load.style.display='none';el.img.style.display='block';preloadedImages[n.image]=el.img;};el.img.onerror=()=>el.load.textContent='Error';el.img.src=n.image;}el.locId.textContent=loc;updateBtn(el.fwd,n.forward);updateBtn(el.bwd,n.backward);updateBtn(el.left,n.left);updateBtn(el.right,n.right);updateAdminPanel();preloadAdjacentImages();}
function updateBtn(b,h){b.disabled=!h;}
function nav(d){const n=g[loc][d];if(n&&g[n]){loc=n;updateView();}}
function attachListeners(){el.fwd.onclick=()=>nav('forward');el.bwd.onclick=()=>nav('backward');el.left.onclick=()=>nav('left');el.right.onclick=()=>nav('right');el.adminT.onclick=()=>openAdminPanel();document.onkeydown=e=>{if(e.key==='Escape'&&el.adminP.classList.contains('open')){el.adminP.classList.remove('open');return;}if(e.key==='Escape'&&document.getElementById('passwordModal').classList.contains('active')){closePasswordModal();return;}if(e.key==='Escape'&&el.camM.classList.contains('active')){closeCamera();return;}if(el.adminP.classList.contains('open')||document.getElementById('passwordModal').classList.contains('active')||el.camM.classList.contains('active'))return;if(['ArrowUp','w','W'].includes(e.key)&&!el.fwd.disabled)nav('forward');if(['ArrowDown','s','S'].includes(e.key)&&!el.bwd.disabled)nav('backward');if(['ArrowLeft','a','A'].includes(e.key)&&!el.left.disabled)nav('left');if(['ArrowRight','d','D'].includes(e.key)&&!el.right.disabled)nav('right');};}

// Camera functions
async function openCameraForDirection(d){capMode='direction';capDir=d;document.getElementById('cameraTitle').textContent=`üì∑ Capture ${d.toUpperCase()}`;await openCamera();}
async function openCameraForNewNode(){capMode='newNode';capDir=null;document.getElementById('cameraTitle').textContent='üì∑ Capture New Node';await openCamera();}
async function openCamera(){try{cam=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:1920,height:1080}});el.camV.srcObject=cam;el.camM.classList.add('active');el.capP.style.display='none';el.camV.style.display='block';document.getElementById('captureBtn').style.display='inline-block';document.getElementById('retakeBtn').style.display='none';document.getElementById('useCaptureBtn').style.display='none';capData=null;}catch(e){showStatus('Camera error - use upload instead','error');console.error(e);}}
function captureImage(){el.capC.width=el.camV.videoWidth;el.capC.height=el.camV.videoHeight;const ctx=el.capC.getContext('2d');ctx.drawImage(el.camV,0,0);const maxSize=1200;let width=el.capC.width;let height=el.capC.height;if(width>maxSize||height>maxSize){const canvas2=document.createElement('canvas');if(width>height){canvas2.height=(height/width)*maxSize;canvas2.width=maxSize;}else{canvas2.width=(width/height)*maxSize;canvas2.height=maxSize;}canvas2.getContext('2d').drawImage(el.capC,0,0,canvas2.width,canvas2.height);capData=canvas2.toDataURL('image/jpeg',0.85);}else{capData=el.capC.toDataURL('image/jpeg',0.85);}el.capP.src=capData;el.camV.style.display='none';el.capP.style.display='block';document.getElementById('captureBtn').style.display='none';document.getElementById('retakeBtn').style.display='inline-block';document.getElementById('useCaptureBtn').style.display='inline-block';}
function retakeImage(){el.capP.style.display='none';el.camV.style.display='block';document.getElementById('captureBtn').style.display='inline-block';document.getElementById('retakeBtn').style.display='none';document.getElementById('useCaptureBtn').style.display='none';capData=null;}

function useCapturedImage(){
    if(!capData){showStatus('No image captured','error');return;}
    const nid=`node_${nCnt++}`;
    localforage.setItem('nodeCounter',nCnt);
    
    if(capMode==='direction'){
        g[nid]={image:capData,forward:null,backward:null,left:null,right:null};
        g[loc][capDir]=nid;
        const rev={'forward':'backward','backward':'forward','left':'right','right':'left'};
        g[nid][rev[capDir]]=loc;
        save();
        updateView();
        updateNodeList();
        showStatus(`${capDir} created: ${nid}`,'success');
    }else if(capMode==='newNode'){
        g[nid]={image:capData,forward:null,backward:null,left:null,right:null};
        document.getElementById('newNodeId').value=nid;
        document.getElementById('newNodeImage').value='Captured';
        save();
        updateNodeList();
        showStatus(`Created: ${nid}`,'success');
    }
    closeCamera();
}

function closeCamera(){if(cam){cam.getTracks().forEach(t=>t.stop());cam=null;}el.camM.classList.remove('active');capData=null;}

// Admin functions
function openAdminPanel(){document.getElementById('passwordModal').classList.add('active');document.getElementById('passwordInput').value='';document.getElementById('passwordError').style.display='none';document.getElementById('passwordInput').focus();}
function closePasswordModal(){document.getElementById('passwordModal').classList.remove('active');}
function checkPassword(){const pwd=document.getElementById('passwordInput').value;if(pwd==='Nawd@9950'){document.getElementById('passwordModal').classList.remove('active');el.adminP.classList.add('open');document.getElementById('passwordInput').value='';}else{document.getElementById('passwordError').style.display='block';document.getElementById('passwordInput').value='';document.getElementById('passwordInput').focus();}}
function updateAdminPanel(){document.getElementById('adminCurrentLocation').textContent=loc;const n=g[loc];updateDirStatus('forward',n.forward);updateDirStatus('backward',n.backward);updateDirStatus('left',n.left);updateDirStatus('right',n.right);document.getElementById('forwardInput').value=n.forward||'';document.getElementById('backwardInput').value=n.backward||'';document.getElementById('leftInput').value=n.left||'';document.getElementById('rightInput').value=n.right||'';}
function updateDirStatus(d,l){const s=document.getElementById(`${d}Status`);s.innerHTML=l?`<div class="current-link">‚úÖ ${l}</div>`:`<div class="no-link-indicator">‚ùå No link</div>`;}
function setDirection(d){const t=document.getElementById(`${d}Input`).value.trim();if(!t){showStatus('Enter ID','error');return;}if(!g[t]){showStatus('Node not found','error');return;}g[loc][d]=t;save();updateView();showStatus(`${d} set to ${t}`,'success');}
function removeDirection(d){g[loc][d]=null;save();updateView();showStatus(`${d} removed`,'success');}

function addNewNode(){
    const id=document.getElementById('newNodeId').value.trim();
    const img=document.getElementById('newNodeImage').value.trim();
    if(!id){showStatus('Enter ID','error');return;}
    if(g[id]){showStatus('Exists','error');return;}
    if(!img){showStatus('Upload image','error');return;}
    
    g[id]={image:img,forward:null,backward:null,left:null,right:null};
    save();
    updateNodeList();
    document.getElementById('newNodeId').value='';
    document.getElementById('newNodeImage').value='';
    showStatus(`Created ${id}`,'success');
}

function updateNodeList(){const nl=document.getElementById('nodeList');nl.innerHTML='';Object.keys(g).sort().forEach(id=>{const d=document.createElement('div');d.className='node-item';d.textContent=`Node ${id}`;d.onclick=()=>{loc=id;updateView();showStatus(`‚Üí ${id}`,'success');};nl.appendChild(d);});}
function save(){localforage.setItem('campusNav',g);}
function showStatus(m,t){const s=document.getElementById('statusMessage');s.textContent=m;s.className=`status-message ${t}`;s.style.display='block';setTimeout(()=>s.style.display='none',4000);}

// File upload functions
function uploadForDirection(d){uploadMode='direction';uploadDir=d;document.getElementById('fileUpload').click();}
function uploadForNewNode(){uploadMode='newNode';uploadDir=null;document.getElementById('fileUpload').click();}

function handleFileUpload(e){
    const file=e.target.files[0];
    if(!file){return;}
    const reader=new FileReader();
    reader.onload=function(ev){
        const img=new Image();
        img.onload=function(){
            const canvas=document.createElement('canvas');
            const ctx=canvas.getContext('2d');
            let width=img.width;
            let height=img.height;
            const maxSize=1200;
            if(width>maxSize||height>maxSize){
                if(width>height){
                    height=(height/width)*maxSize;
                    width=maxSize;
                }else{
                    width=(width/height)*maxSize;
                    height=maxSize;
                }
            }
            canvas.width=width;
            canvas.height=height;
            ctx.drawImage(img,0,0,width,height);
            const imgData=canvas.toDataURL('image/jpeg',0.85);
            
            const nid=`node_${nCnt++}`;
            localforage.setItem('nodeCounter',nCnt);
            
            if(uploadMode==='direction'){
                g[nid]={image:imgData,forward:null,backward:null,left:null,right:null};
                g[loc][uploadDir]=nid;
                const rev={'forward':'backward','backward':'forward','left':'right','right':'left'};
                g[nid][rev[uploadDir]]=loc;
                save();
                updateView();
                updateNodeList();
                showStatus(`${uploadDir} created: ${nid}`,'success');
            }else if(uploadMode==='newNode'){
                g[nid]={image:imgData,forward:null,backward:null,left:null,right:null};
                document.getElementById('newNodeId').value=nid;
                document.getElementById('newNodeImage').value='Uploaded';
                save();
                updateNodeList();
                showStatus(`Created: ${nid}`,'success');
            }
            e.target.value='';
        };
        img.src=ev.target.result;
    };
    reader.readAsDataURL(file);
}

// Export Functions
function openExportModal(){
    document.getElementById('exportModal').classList.add('active');
}

function closeExportModal(){
    document.getElementById('exportModal').classList.remove('active');
}

function exportAllData(){
    // Create a clean copy without circular references
    const exportData = JSON.parse(JSON.stringify(g));
    
    // Create a zip file with all data
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    // Download JSON
    const a = document.createElement('a');
    a.href = URL.createObjectURL(dataBlob);
    a.download = `campus_nav_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // Also extract and save images
    extractAndSaveImages();
    
    showStatus('All data exported successfully!', 'success');
    closeExportModal();
}

function exportImagesOnly(){
    extractAndSaveImages();
    showStatus('All images exported!', 'success');
    closeExportModal();
}

function exportStructureOnly(){
    // Create structure-only export (replace image data with filenames)
    const structureData = {};
    Object.keys(g).forEach(key => {
        structureData[key] = {
            forward: g[key].forward,
            backward: g[key].backward,
            left: g[key].left,
            right: g[key].right,
            image: g[key].image.startsWith('data:') ? 'data_image.jpg' : g[key].image
        };
    });
    
    const dataStr = JSON.stringify(structureData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const a = document.createElement('a');
    a.href = URL.createObjectURL(dataBlob);
    a.download = `campus_structure_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    showStatus('Structure exported!', 'success');
    closeExportModal();
}

function extractAndSaveImages(){
    // Extract all data URLs and save them as image files
    Object.keys(g).forEach(nodeId => {
        const imageData = g[nodeId].image;
        if(imageData.startsWith('data:image/')) {
            // Convert data URL to blob
            const byteString = atob(imageData.split(',')[1]);
            const mimeString = imageData.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            const blob = new Blob([ab], {type: mimeString});
            
            // Create download link
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${nodeId}_image.jpg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Clean up
            setTimeout(() => URL.revokeObjectURL(a.href), 100);
        }
    });
}

function exportData(){
    // Simple backup export
    const backup = {
        graph: g,
        nodeCounter: nCnt,
        exportDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(backup, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const a = document.createElement('a');
    a.href = URL.createObjectURL(dataBlob);
    a.download = `campus_backup_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    showStatus('Backup created!', 'success');
}

window.onload=init;
    </script>
</body>
</html>



